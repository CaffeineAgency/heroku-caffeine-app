{% extends "base.html" %}
{% load staticfiles %}

{% block content %}

<style>
	img { cursor: pointer }
	.nomargin { margin: 0 }
</style>
<div class="jumbotron jumbotron-fluid">
	<div class="container">
		<h1 class="display-3">Reactor gallery</h1>
		<p class="lead">Галерея пикч из джойреакторовского тега <i>"красивые картинки"</i>.</p>
	</div>
</div>
<div class="container-fluid">
	<br>
	<br>
	<div class="row">
		<div class="col"></div>
		<div class="col-10">
			<section class="card-columns">
			</section>
		</div>
		<div class="col"></div>
	</div>
	<br>
	<br>
	<button class="btn btn-success col" onclick="upd()">Load more!</button>
	<br>

</div>
<script type="application/javascript">
	function getImages(tag, page) {
		return new Promise(function(resolve, reject) {
			var req_data = {
				mode: "reactorparser",
				tag: tag,
				page: page
			}
			console.log([tag, page]);
			$.ajax({
				type: 'GET',
				url: '/acollection',
				data: req_data,
				encode: true
			}).done(function(data) {
				resolve(data);
			}).fail(function(data) {
				alert("Something went wrong. Check console or network tab in dev tools for more info.")
				reject(new Error(data));
			});
		});
	}

	function generateCard(post) {
		var author = post.author;
		var tags = post.tags;
		var images = post.images;

		var div = document.createElement("div");
		div.className = "card";
		div.style = {
			width: "20rem"
		};

		var div_ch = document.createElement("div");
		div_ch.className = "row card-header nomargin";
		var img_ava = document.createElement("img");
		img_ava.className = "rounded mr-2";
		img_ava.src = author.avatar;
		img_ava.alt = author.nick;
		div_ch.appendChild(img_ava);
		div_ch.append(author.nick);
		div.appendChild(div_ch);


		images.forEach(function(image) {
			var img = document.createElement("img");
			img.className = "card-img-top";
			img.src = image;
			div.appendChild(img);
			div.appendChild(document.createElement("br"))
		});

		var div_cb = document.createElement("div");
		div_cb.className = "card-body";
		var p_ct = document.createElement("p");
		p_ct.className = "card-text";

		tags.forEach(function(tag) {
			var span_tag = document.createElement("span");
			span_tag.className = "badge badge-light";
			span_tag.textContent = tag;
			div_cb.appendChild(span_tag);
			div_cb.append(" ");
		});
		div_cb.appendChild(p_ct);
		div.appendChild(div_cb);
		$("section.card-columns").prepend(div);
	}

	//$(function() {	//Нужно выполнять этот код только после загрузки документа. А может, не нужно. Я не знаю, всё вроде работает и без этого.
	var parsed_json, posts, nextPage
	getImages("красивые+картинки", "latest")
		.then(function(response) {
			parsed_json = user = JSON.parse(response);
			posts = parsed_json.posts;
			nextPage = parsed_json.lp-1;
			posts.forEach(function(entry) {
				generateCard(entry);
			});
		})
		.catch(console.log);

	$(window).scroll(function() {
		if ($(window).scrollTop() == $(document).height() - $(window).height()) {
			if (nextPage > 1) {
				upd();
			}
		}
	});

	function upd() {
		getImages("красивые+картинки", "latest")
			.then(function(response) {
				parsed_json = user = JSON.parse(response);
				posts = parsed_json.posts;
				nextPage--;
				posts.forEach(function(entry) {
					generateCard(entry);
				});
			}).catch(console.log);
		console.log(nextPage);
	};
	//});
</script>
{% endblock %}